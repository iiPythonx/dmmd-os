! name:  Configure App Sources
! icon:  data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAJFBMVEUAAACAgID////AwMAA/wAAgAAAAID/AAAAAP8AgIAAAAAA//9zvTsUAAAAAXRSTlMAQObYZgAAAAFiS0dEAmYLfGQAAAAHdElNRQfiBBMBJTjhR0zWAAABcUlEQVQoz02RP0/DMBDFzcDCRhETWykDYkPmC5DcwoQUH209sWCsjEgoqHuNE+ZKlrpEah1Ft1eCb8clKX/eZL/7+dm+E6LXMUv86eB4LKXC+9/96DxJANA87o1RX8fCuT0wljeAbARbD8A5wPRtOS8bl+8BhdMFtSG3pkNOMs6blWVFVJgOGe040IcQVlAYzSeur1bAQFkqahBqjvja4YzrS2qjvGHjar3Gvq6rTcLEyeXXJwcEsm2zlUqL0Xr1wQD5ysUNABu7jBMo+I2WW4VanGXjiznxM+RdEgFJnF7fphSCb9V2ILLJhOa+rPxyAz0xfaEUZ771uZRb1FpMF2maYuFdlQzE4SQFgML7qBQTtTi8TVOlcOaihoiRDckA/z+3bYwdIVQn/b5w7v2VI4TIOkI/v1n7vOBLBJ/hCO1YD4b6LiOgbq21T3d9BxlBbDrgSZthDAI1140xTb6f3FFjeuX1z3CPqNtT/W/+xBpW3/A1qZ4HUdqNAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTA0LTE5VDAxOjM3OjU2LTA0OjAwpCxaWQAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0wNC0xOVQwMTozNzo1Ni0wNDowMNVx4uUAAAAASUVORK5CYII=
! title: Sources

<style>
    * {
        color: black;
    }
    fieldset {
        margin: 10px;
    }
    div {
        margin-top: 10px;
    }
    th, td {
        padding-left: 10px;
        padding-right: 10px;
    }
    .ok {
        color: green;
    }
    .error {
        color: red;
    }
</style>

<fieldset>
    <legend>Source List</legend>
    <table></table>
    <div>
        <button id = "add">+</button>
        <button id = "move-up">↑</button>
        <button id = "move-down">↓</button>
        <button id = "remove">-</button>
    </div>
</fieldset>

<script>(async () => {
    const dom = roots["%OS_ROOT"];

    class SourceHandler {
        constructor() {
            this.sources = [];

            // Connect to DOM events
            dom.getElementById("add").addEventListener("click", () => {
                window.on_source_added = async () => {
                    await this.load_sources();
                    delete window.on_source_added;
                }
                exe.launch("sys/settings/source-add");
            });
            dom.getElementById("move-up").addEventListener("click", () => {
                const source = this.get_source();
                if (source) this.move_source_up(source);
            });
            dom.getElementById("move-down").addEventListener("click", () => {
                const source = this.get_source();
                if (source) this.move_source_down(source);
            });
            dom.getElementById("remove").addEventListener("click", () => {
                for (const source in this.get_sources()) this.sources.splice(this.sources.indexOf(source), 1);
                this.draw_sources();
            });
        }

        get_sources() {
            const sources = [];
            for (const source of dom.querySelectorAll("input:checked")) {
                sources.push(this.sources.filter(_ => _.url === source.parentElement.parentElement.querySelector(".url").innerText)[0]);
            }
            return sources;
        }

        get_source() {
            const sources = this.get_sources();
            if (!sources) return;
            if (sources.length > 1) return create_error("Failed to move", "You can only move a single app at a time.");
            return sources[0];
        }

        draw_sources() {
            dom.querySelector("table").innerHTML = `
                <tr>
                    <th></th>
                    <th>Source</th>
                    <th>App Count</th>
                    <th>Status</th>
                </tr>
            `;
            for (const source of this.sources) {
                const source_element = document.createElement("tr");
                source_element.innerHTML = `
                <td><input type = "checkbox"></td>
                <td class = "url">${source.url}</td>
                <td>${source.apps || 'N/A'}</td>
                ${source.status ? "<td class = 'ok'>OK</td>" : "<td class = 'error'>ERROR</td>"}
                `;
                dom.querySelector("table").appendChild(source_element);
            }
            db.set("app-sources", JSON.stringify(this.sources));
        }

        move_source_up(source) {
            const index = this.sources.indexOf(source);
            if (index === 0) return;
            this.sources = this.sources.slice(0, index - 1).concat([source, this.sources[index - 1]], this.sources.slice(index + 1))
            this.draw_sources();
        }

        move_source_down(source) {
            const index = this.sources.indexOf(source);
            if (index === this.sources.length - 1) return;
            this.sources = this.sources.slice(0, index).concat([this.sources[index + 1], source], this.sources.slice(index + 2));
            this.draw_sources();
        }

        async load_sources() {
            this.sources = JSON.parse(await db.get("app-sources"));
            if (this.sources.constructor !== Array) return console.error("[Sources] Something fucked up and I don't like it.");
            this.draw_sources();
        }
    }

    // Initialization
    (new SourceHandler()).load_sources();
})();</script>
